<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>IPv6 FAQ - Fog&#39;s Blog</title><meta name="Description" content="Technology sharing"><meta property="og:title" content="IPv6 FAQ" />
<meta property="og:description" content="本来是想写一篇 IPv6 的文档，可以帮助不熟悉 IPv6 的同事快速了解 IPv6。但是后来发现越写越庞大，太过细节，重复了很多 IPv6 书籍中的内容，从而偏离了原本的" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://f0ghua.github.io/ipv6_faq/" /><meta property="og:image" content="https://f0ghua.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-11T16:33:00+08:00" />
<meta property="article:modified_time" content="2023-09-12T14:03:19+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://f0ghua.github.io/logo.png"/>

<meta name="twitter:title" content="IPv6 FAQ"/>
<meta name="twitter:description" content="本来是想写一篇 IPv6 的文档，可以帮助不熟悉 IPv6 的同事快速了解 IPv6。但是后来发现越写越庞大，太过细节，重复了很多 IPv6 书籍中的内容，从而偏离了原本的"/>
<meta name="application-name" content="Fog&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Fog&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://f0ghua.github.io/ipv6_faq/" /><link rel="prev" href="https://f0ghua.github.io/openwrt-luci/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "IPv6 FAQ",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/f0ghua.github.io\/ipv6_faq\/"
        },"image": ["https:\/\/f0ghua.github.io\/images\/Apple-Devices-Preview.png"],"genre": "posts","wordcount":  5897 ,
        "url": "https:\/\/f0ghua.github.io\/ipv6_faq\/","datePublished": "2023-09-11T16:33:00+08:00","dateModified": "2023-09-12T14:03:19+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": "https:\/\/f0ghua.github.io\/images\/avatar.png"},"author": {
                "@type": "Person",
                "name": "fog"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Fog&#39;s Blog"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>Fog&#39;s Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/categories/documentation/"> 文档 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="https://github.com/dillonzq/LoveIt" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item language" title="选择语言">简体中文<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/ipv6_faq/" selected>简体中文</option></select>
                    </a><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Fog&#39;s Blog"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>Fog&#39;s Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/categories/documentation/" title="">文档</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="https://github.com/dillonzq/LoveIt" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="选择语言">简体中文<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/ipv6_faq/" selected>简体中文</option></select>
                </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">IPv6 FAQ</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>fog</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2023-09-11">2023-09-11</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 5897 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 12 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#faqs">FAQs</a>
      <ul>
        <li><a href="#q-ipv6-的地址如何表示">Q: IPv6 的地址如何表示？</a></li>
        <li><a href="#q-为什么显示的-ipv6-地址后面有-64">Q: 为什么显示的 IPv6 地址后面有 <code>/64</code> ?</a></li>
        <li><a href="#q-为什么我的网卡上会显示多个-ipv6-地址">Q: 为什么我的网卡上会显示多个 IPv6 地址？</a>
          <ul>
            <li><a href="#单播-unicast">单播（unicast）</a></li>
            <li><a href="#多播-multicast">多播（multicast）</a></li>
          </ul>
        </li>
        <li><a href="#q-linux-使用-ip-命令查看的时候可以看到每个-ipv6-地址后面都有-lifetime-这是什么意思">Q: Linux 使用 ip 命令查看的时候可以看到每个 IPv6 地址后面都有 lifetime，这是什么意思 ？</a></li>
        <li><a href="#q-一个接口上的-ipv6-地址是如何产生的">Q: 一个接口上的 IPv6 地址是如何产生的？</a></li>
        <li><a href="#q-链路本地地址-lla-是如何生成的">Q: 链路本地地址（LLA）是如何生成的？</a></li>
        <li><a href="#什么是网络发现协议-ndp-network-discovery-protocol">什么是网络发现协议（ NDP - Network Discovery Protocol）？</a>
          <ul>
            <li><a href="#邻居发现协议">邻居发现协议</a></li>
            <li><a href="#路由发现协议">路由发现协议</a></li>
          </ul>
        </li>
        <li><a href="#q-ula-和-gua-是如何获取的">Q: ULA 和 GUA 是如何获取的？</a></li>
        <li><a href="#q-slaac-是怎么工作的">Q: SLAAC 是怎么工作的？</a></li>
        <li><a href="#q-什么是-dhcpv6-stateless-和-dhcpv6-stateful">Q: 什么是 DHCPv6 Stateless 和 DHCPv6 Stateful?</a></li>
        <li><a href="#q-slaac-和-dhcpv6-是如何协同工作的">Q: SLAAC 和 DHCPv6 是如何协同工作的？</a></li>
        <li><a href="#q-openwrt-中是如何通过配置项实现-ipv6-各种获取-ip-的方式的">Q: OpenWRT 中是如何通过配置项实现 IPv6 各种获取 IP 的方式的？</a></li>
        <li><a href="#q-如何使用-wireshark-过滤-slaac-和-dhcpv6-的封包">Q: 如何使用 wireshark 过滤 slaac 和 dhcpv6 的封包？</a></li>
      </ul>
    </li>
    <li><a href="#appendix">Appendix</a>
      <ul>
        <li><a href="#ipv6-rfcs">IPv6 RFCs</a></li>
        <li><a href="#references">References</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>本来是想写一篇 IPv6 的文档，可以帮助不熟悉 IPv6 的同事快速了解 IPv6。但是后来发现越写越庞大，太过细节，重复了很多 IPv6 书籍中的内容，从而偏离了原本的目的。所以最终还是决定以 FAQ 的形式提供速查。</p>
<h2 id="faqs">FAQs</h2>
<h3 id="q-ipv6-的地址如何表示">Q: IPv6 的地址如何表示？</h3>
<p>IPv6 的地址使用 128 bits 表示，每 16 bits 为一组，用冒号分隔，分成 8 组，如</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">2001:0db8:0000:0000:0001:0002:0003:0004
</code></pre></td></tr></table>
</div>
</div><p>为了便于输入和记忆，我们可以将之简化</p>
<ul>
<li>去除每组前面的 0，上面的地址变为: <code>2001:db8:0:0:1:2:3:4</code></li>
<li>如果是连续的多组 0，那么可以直接简化为 <code>::</code> ，地址变为： <code>2001:db8::1:2:3:4</code></li>
</ul>
<h3 id="q-为什么显示的-ipv6-地址后面有-64">Q: 为什么显示的 IPv6 地址后面有 <code>/64</code> ?</h3>
<p>一个 IPv6 的地址，可以分为网络地址和主机地址 2 个部分。通过网络前缀可以指定网络地址所占用的位数。如果要表示一个 IPv6 的网络前缀（表示一个网段），可以用 <code>ipv6地址/前缀长度</code> 的格式。如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">2001:db8::1:2:3:4/64
</code></pre></td></tr></table>
</div>
</div><p>表示地址的前 64 bits（ <code>2001:db8::</code> ）为网络地址，其余的（ <code>1:2:3:4</code> ）为主机地址。</p>
<h3 id="q-为什么我的网卡上会显示多个-ipv6-地址">Q: 为什么我的网卡上会显示多个 IPv6 地址？</h3>
<p>一个接口可以拥有多个 IPv6 的地址，在 RFC4291 中定义了不同 IPv6 地址的用途和地址范围。</p>
<p>从类型上来说，IPv6 地址主要分为单播（unicast），多播（multicast），
anycast（RFC1546）等几种。anycast 地址很少涉及，所以这里不予讨论。</p>
<h4 id="单播-unicast">单播（unicast）</h4>
<p>单播地址可以细分为以下几种（这里用 IPv4 做对比，便于理解其用途）</p>
<table>
<thead>
<tr>
<th>Scope</th>
<th>RFC</th>
<th>Prefix</th>
<th>IPv4 equivalent</th>
</tr>
</thead>
<tbody>
<tr>
<td>Link Local</td>
<td>4291</td>
<td>fe80::/10</td>
<td>169.254.0.0/16</td>
</tr>
<tr>
<td>Unique Local</td>
<td>4193</td>
<td>fc00::/8 fd00::/8</td>
<td>10.0.0.0/8, 172.16.0.0/12,</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>192.168.0.0/16</td>
</tr>
<tr>
<td>Global</td>
<td>4291</td>
<td>2000:/3</td>
<td>class A,B,C except private</td>
</tr>
<tr>
<td>Loopback</td>
<td>4291</td>
<td>::1/128</td>
<td>127.0.0.1</td>
</tr>
<tr>
<td>Unspecified</td>
<td>4291</td>
<td>::/128</td>
<td>0.0.0.0</td>
</tr>
</tbody>
</table>
<!--list-separator-->
<ul>
<li>
<p>链路本地地址（LLA - Link Local Address）</p>
<p>由前缀 <code>fe80::/10</code> 指定</p>
<ul>
<li>环回地址（ <code>::1</code> ）作为一个特殊的链路本地地址，相当于 IPv4 的 <code>127.0.0.1</code></li>
<li>链路本地地址只在接口所连接的本地网络链路上有效</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>唯一本地地址（ULA - Unique Local Address）</p>
<p>这就是我们通常所说的私网地址。只在本地局域网内有效，其跟 LLA 的区别在于 ULA 可以跨路由器，而 LLA 不可以。</p>
<p>唯一本地地址（ULA）由前缀 <code>fc00::/7</code> 指定。可以分为 <code>fc00::/8</code> 和 <code>fd00::/8</code> 两个 block 。</p>
<p>RFC 4193 定义了 ULA 的地址格式如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">
  <span class="p">|</span> <span class="m">7</span> bits <span class="p">|</span>1<span class="p">|</span>  <span class="m">40</span> bits   <span class="p">|</span>  <span class="m">16</span> bits  <span class="p">|</span>          <span class="m">64</span> bits           <span class="p">|</span>
  +--------+-+------------+-----------+----------------------------+
  <span class="p">|</span> Prefix <span class="p">|</span>L<span class="p">|</span> Global ID  <span class="p">|</span> Subnet ID <span class="p">|</span>        Interface ID        <span class="p">|</span>
  +--------+-+------------+-----------+----------------------------+

</code></pre></td></tr></table>
</div>
</div><p>其中</p>
<ul>
<li><code>L</code> 0 作为预留不适用，所以该值总是为 1。也就是说有效的前缀值目前只有 <code>fd00::/8</code></li>
<li><code>Global ID</code> 这是一个 40 bits 的伪随机值，保证了每次生成的都是一个唯一值。之所以添加这个字段，是为了让 ULA 具备 GUA 的唯一性属性，从而在不同网络进行合并的时候可以避免地址前缀冲突的问题。</li>
</ul>
<p>更多的信息可以参考以下几份资料</p>
<ul>
<li><a href="https://blog.apnic.net/2020/05/20/getting-ipv6-private-addressing-right/" target="_blank" rel="noopener noreffer">Getting IPv6 private addressing right</a></li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>全球单播地址（GUA - Global Unicast Address）</p>
<p>这就是我们通常所说的公网地址。它的有效范围是全球网络。</p>
</li>
</ul>
<h4 id="多播-multicast">多播（multicast）</h4>
<p>在 IPv6 中没有广播地址，所以对于需要发送给多个接收端的封包，使用了多播地址（有的文献里也会翻译成组播）。</p>
<p>多播地址的地址范围定义则如下所示：</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>RFC</th>
<th>Prefix</th>
<th>IPv4 equivalent</th>
</tr>
</thead>
<tbody>
<tr>
<td>Multicast</td>
<td>4291</td>
<td>ff00::/8</td>
<td>224.0.0.0/4</td>
</tr>
</tbody>
</table>
<p>常用的多播地址如下表所示</p>
<table>
<thead>
<tr>
<th>Address</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ff01::1</td>
<td>All nodes in the interface-local</td>
</tr>
<tr>
<td>ff02::1</td>
<td>All nodes in the link-local</td>
</tr>
<tr>
<td>ff01::2</td>
<td>All routers in the interface-local</td>
</tr>
<tr>
<td>ff02::2</td>
<td>All routers in the link-local</td>
</tr>
</tbody>
</table>
<p>地址 <code>ff01::1</code> 的说明可能比较难理解，关键在于 <code>interface-local</code> ，指的是接口本地范围。</p>
<p>RFC4297 中对此的说明如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">Interface-Local scope spans only a single interface on a node and is useful only
<span class="k">for</span> loopback transmission of multicast.
</code></pre></td></tr></table>
</div>
</div><p>简单来讲，ff01::1 只用于本地还回地址的多播。当 lo interface 起来的时候会加入该多播组。</p>
<h3 id="q-linux-使用-ip-命令查看的时候可以看到每个-ipv6-地址后面都有-lifetime-这是什么意思">Q: Linux 使用 ip 命令查看的时候可以看到每个 IPv6 地址后面都有 lifetime，这是什么意思 ？</h3>
<p>对于每一个 IPv6 地址来说，有两个 Lifetime。这两个时间在接口获得 ip 的时候就开始倒计时。</p>
<ul>
<li>
<p>preferred-lifetime 首选生存期。表示前缀可用的时间范围。在此范围内，前缀地址可以作为源地址或者目的地址自由使用。当生存期倒计时归零，则地址变的不可用（除了之前开始尚未结束的相关事务）</p>
</li>
<li>
<p>valid-lifetime 前缀在不可用之前保持可用的总时间。首选生存期到期后，任何自动配置的地址都将被弃用，并且仅用于在首选生存期到期之前开始的事务。如果有效生存期也过期，则地址将变得完全不可用。</p>
</li>
</ul>
<p>因此，随着这两个 lifetime 的变化，IPv6 地址也会表现为不同的状态，如下图所示</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">
     ┌────────────┬────────────────────┬────────────────────┬───────────────────┐
     │            │                    │                    │                   │
     │    DAD     │     preferred      │    deprecated      │     invalid       │
     │            │                    │                    │                   │
 ────┴────────────┴────────────────────┴────────────────────┴───────────────────┴──►

     ┼  invalid   ┼                  valid                  ┼     invalid       ┼

                  ┼   new connection   ┼    old connection  ┼



                  │  preferred lft out │
 ─────────────────┼────────────────────┴────────────────────┬──────────────────────►
                  │                      deprecated lft out │

</code></pre></td></tr></table>
</div>
</div><p>这些地址状态在 RFC4862 中定义，简单描述则如下所示</p>
<ul>
<li>preferred 新连接使用的地址。当 preferred lifetime 过期则地址变成 deprecated</li>
<li>deprecated 旧连接使用的地址。当 valid lifetime 过期则地址变成 invalid</li>
<li>valid 有效地址。包括 preferred address 和 deprecated address</li>
<li>invalid 无效地址</li>
</ul>
<h3 id="q-一个接口上的-ipv6-地址是如何产生的">Q: 一个接口上的 IPv6 地址是如何产生的？</h3>
<p>简单的说，链路本地地址（LLA）和环回地址由系统自身生成；而唯一本地地址（ULA）和全球单播地址（GUA）则是由服务器分配而来。这里说的服务器，提供的可以是路由器的 radvd
服务，也可以是 dhcpv6 服务。</p>
<h3 id="q-链路本地地址-lla-是如何生成的">Q: 链路本地地址（LLA）是如何生成的？</h3>
<p>链路本地地址由本机独立产生，不依赖于外部环境。产生的过程大致如下：</p>
<ul>
<li>获取网卡的 MAC 地址，如 <code>00:e0:81:2e:b6:d1</code></li>
<li>反转第一字节的第二比特： <code>02:e0:81:2e:b6:d1</code></li>
<li>在中间插入 2 字节 <code>FFFE</code> ，扩展到 MAC 地址到 64 位 : <code>02:e0:81:FF:FE:2e:b6:d1</code></li>
<li>加上 LLA 的前缀 <code>fe80::/64</code> : <code>fe80::2e0:81FF:FE2e:b6d1</code></li>
</ul>
<p>前面三步从 48 位的 MAC 转换成 64 位主机地址的过程称为 EUI64。</p>
<p>需要注意的是，该地址产生之后，还需要使用 NDP（Network Discovery Protocol）协议，向本地链路发送 NS 包，执行 DAD 检测，检查是否该地址已经被占用。如果有人回复 NA，那就说明有冲突，需要人工校正。</p>
<h3 id="什么是网络发现协议-ndp-network-discovery-protocol">什么是网络发现协议（ NDP - Network Discovery Protocol）？</h3>
<p>网络发现协议（NDP）定义在 RFC4861 中，主要包含了 2 部分的内容。</p>
<ul>
<li>NS, NA</li>
<li>RS, RA</li>
</ul>
<h4 id="邻居发现协议">邻居发现协议</h4>
<p>邻居发现协议主要用来查询 IPv6 地址对应的主机的 MAC 地址。使用到了两种类型的封包，即
NS 和 NA。</p>
<p>一个正常的 NS， NA 交互如图所示</p>
<p><figure><a class="lightgallery" href="/ox-hugo/ipv6_faq.img.66ad38d7.png" title="ns_na" data-thumbnail="/ox-hugo/ipv6_faq.img.66ad38d7.png" data-sub-html="<h2>ns_na</h2><p>ns_na</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/ox-hugo/ipv6_faq.img.66ad38d7.png"
            data-srcset="/ox-hugo/ipv6_faq.img.66ad38d7.png, /ox-hugo/ipv6_faq.img.66ad38d7.png 1.5x, /ox-hugo/ipv6_faq.img.66ad38d7.png 2x"
            data-sizes="auto"
            alt="/ox-hugo/ipv6_faq.img.66ad38d7.png" />
    </a><figcaption class="image-caption">ns_na</figcaption>
    </figure></p>
<p>完整的封包可以 <a href="https://www.cloudshark.org/captures/798fa8a6506a" target="_blank" rel="noopener noreffer">在线查看</a> ，也可以从以下链接下载</p>
<ul>
<li><a href="/ox-hugo/ipv6_faq.file.ns_na.pcap" rel="">ipv6_faq.file.ns_na.pcap</a></li>
</ul>
<p>要查看 NDP 的解析结果，Linux 下可以通过以下命令查看</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">ip -6 neighbor show
</code></pre></td></tr></table>
</div>
</div><p>输出为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">fe80::200:ff:feaa:2 dev eth0 lladdr 00:00:00:aa:00:02 router STALE
</code></pre></td></tr></table>
</div>
</div><p>该命令类似 ipv4 的 <code>arp -a</code></p>
<h4 id="路由发现协议">路由发现协议</h4>
<p>路由发现协议则是主机用来查找网络中的路由器（网关）。主要使用的封包类型为 RS 和 RA。</p>
<p>当路由启用了 radvd 服务，那么每次启动后就会向本地链路网络周期性的发送 RA 封包。主机也可以通过主动发送 RS 封包查询 RA。</p>
<p>通过路由发现协议，主机可以从 RA 包中获取到主机的 IPv6 地址前缀，默认路由的网关地址，以及 DNS 地址（RFC6106）。这样，正常上网所需要的要素就齐全了。</p>
<p>当主机接收到 RA 报文的时候，应该根据报文中的内容添加或者删除路由。具体的规则参考
RFC4191 。</p>
<p>如何添加路由主要看两个地方</p>
<ul>
<li>一个是在 RA 报文的 Flags 中的 <code>Default Router Preference</code> 字段和 <code>Router lifetime</code> 。当 Lifetime 不为 0 的时候，添加默认路由；为 0 时表示删除该路由。观察 <a href="https://www.cloudshark.org/captures/69fd7a31fe57" target="_blank" rel="noopener noreffer">ipv6-router-advertisement-leaving.pcapng</a> 的 packet 1 和 packet 2。主机接收到第一个 RA 的时候就会添加路由，而接受到第二个的时候则会删除默认路由。</li>
<li>另一个是看 Route Information Option，这个里面也有 Preference 和 Lifetime。用法同上，但是优先级要高于前者。两者的区别在于前者只用来管理默认路由，而 Option 大多用来添加某特定前缀的路由</li>
</ul>
<h3 id="q-ula-和-gua-是如何获取的">Q: ULA 和 GUA 是如何获取的？</h3>
<p>IPv6 地址的获取方式可以分为 2 种。一个是 SLAAC，还有一个是 DHCPv6。</p>
<p>SLAAC 协议的具体描述在 RFC4862 中。利用 NDP 中定义的 RA 报文，给主机提供了前缀，路由，默认网关等信息，从而保证了在网络中没有其他服务器的情况，主机可以获取到 IPv6 地址并正常的访问外部网络。</p>
<p>需要注意的是 RFC4862 只考虑了 IP 地址的分配问题，没有考虑到 DNS 的部分。所以按照
RFC4862 实现的 SLAAC，主机是不能正常解析域名的。基于此，又出了一份 RFC6106，给
SLAAC 添加了 DNS 的支持。</p>
<p>DHCPv6 由 RFC8415 定义。实现类似 DHCPv4，就不展开说明了。</p>
<h3 id="q-slaac-是怎么工作的">Q: SLAAC 是怎么工作的？</h3>
<p>SLAAC 的过程大致分为两个阶段：</p>
<ul>
<li>生成链路本地地址（LLA）</li>
<li>使用 Network Discovery 协议生成全球单播地址（GUA）</li>
</ul>
<p>链路本地地址的生成过程在前面已经讲过，这里直接看主机怎么通过 NDP 获取 GUA 的。</p>
<p>对于支持 SLAAC 的网络，网关会定时发送 RA，提供 Prefix 给网络中的主机使用。而每台主机在适当的时机（比如网卡 UP）也会发送 RS 去主动查询。当主机获取到 RA 中包含的
Prefix 后，就可以通过 EUI64 的方式生成 GUA 了。</p>
<p>一个普通的 RA 包的内容如图所示</p>
<p><figure><a class="lightgallery" href="/ox-hugo/ipv6_faq.img.547d0cb3.png" title="ra" data-thumbnail="/ox-hugo/ipv6_faq.img.547d0cb3.png" data-sub-html="<h2>ra</h2><p>ra</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/ox-hugo/ipv6_faq.img.547d0cb3.png"
            data-srcset="/ox-hugo/ipv6_faq.img.547d0cb3.png, /ox-hugo/ipv6_faq.img.547d0cb3.png 1.5x, /ox-hugo/ipv6_faq.img.547d0cb3.png 2x"
            data-sizes="auto"
            alt="/ox-hugo/ipv6_faq.img.547d0cb3.png" />
    </a><figcaption class="image-caption">ra</figcaption>
    </figure></p>
<p>完整的封包可以 <a href="https://www.cloudshark.org/captures/0effd89c29b7" target="_blank" rel="noopener noreffer">在线查看</a> ，也可以从以下链接下载</p>
<ul>
<li><a href="/ox-hugo/ipv6_faq.file.ra.pcap" rel="">ipv6_faq.file.ra.pcap</a></li>
</ul>
<p>可以看到这个 RA 包发送给 link local 上的所有主机，提供了前缀
<code>2401:4900:d00:ffff::/64</code> ，默认网关自己（Lifetime &gt; 0），DNS Server 两个
<code>2401:4900::10</code> 和 <code>2401:4900::11</code></p>
<p>通过这两个阶段，主机就能自动的获取到 IPv6 的 GUA 地址和 Gateway 地址。但是要正常跟外界沟通解析 DNS，还需要 DNS Server 等信息。因此 RFC6106 又给 RA 包中增加了
RDNSS 选项。这样，只需要 SLAAC 就能提供主机和外界交流所需要的全部功能了。</p>
<h3 id="q-什么是-dhcpv6-stateless-和-dhcpv6-stateful">Q: 什么是 DHCPv6 Stateless 和 DHCPv6 Stateful?</h3>
<p>所谓的 Stateless 和 Stateful 是针对 IPv6 地址而言。有状态（Stateful）表示 IPv6
地址的管理（租赁和回收等）由特定的服务完成，这里的服务就是 DHCPv6 Server；而无状态（Stateless）顾名思义就是 IPv6 地址由主机自己生成，DHCPv6 不参与管理。</p>
<p>那么我们都知道 DHCPv6 服务就是用来分配 IP 地址的，搞这么个 Stateless 模式出来又不分配 IP 有什么用呢？这就要回到前面提到过的 SLAAC 模式了。SLAAC 在最初设计的时候并没有 DNS 相关的 option，所以也就无法给主机分配 DNS Server。为了弥补这个缺失，就使用了 DHCPv6 Stateless 来提供相关信息。此时 SLAAC 负责分配 IP，而 DHCPv6 负责提供其他的信息（通过 Information-Request）。</p>
<p>知道了工作机制，再来看一下对应的封包。</p>
<p>DHCPv6 Stateful 的封包如下</p>
<p><figure><a class="lightgallery" href="/ox-hugo/ipv6_faq.img.475e84a0.png" title="dhcpv6_pd" data-thumbnail="/ox-hugo/ipv6_faq.img.475e84a0.png" data-sub-html="<h2>dhcpv6_pd</h2><p>dhcpv6_pd</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/ox-hugo/ipv6_faq.img.475e84a0.png"
            data-srcset="/ox-hugo/ipv6_faq.img.475e84a0.png, /ox-hugo/ipv6_faq.img.475e84a0.png 1.5x, /ox-hugo/ipv6_faq.img.475e84a0.png 2x"
            data-sizes="auto"
            alt="/ox-hugo/ipv6_faq.img.475e84a0.png" />
    </a><figcaption class="image-caption">dhcpv6_pd</figcaption>
    </figure></p>
<p>完整的封包可以 <a href="https://www.cloudshark.org/captures/46311cc06e8e" target="_blank" rel="noopener noreffer">在线查看</a> ，也可以从以下链接下载</p>
<p><a href="/ox-hugo/ipv6_faq.file.dhcpv6_pd.pcap" rel="">ipv6_faq.file.dhcpv6_pd.pcap</a></p>
<p>DHCPv6 Stateless 的封包如下：</p>
<p><figure><a class="lightgallery" href="/ox-hugo/ipv6_faq.img.c351bb2b.png" title="dhcpv6_stateless_no_pd" data-thumbnail="/ox-hugo/ipv6_faq.img.c351bb2b.png" data-sub-html="<h2>dhcpv6_stateless_no_pd</h2><p>dhcpv6_stateless_no_pd</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/ox-hugo/ipv6_faq.img.c351bb2b.png"
            data-srcset="/ox-hugo/ipv6_faq.img.c351bb2b.png, /ox-hugo/ipv6_faq.img.c351bb2b.png 1.5x, /ox-hugo/ipv6_faq.img.c351bb2b.png 2x"
            data-sizes="auto"
            alt="/ox-hugo/ipv6_faq.img.c351bb2b.png" />
    </a><figcaption class="image-caption">dhcpv6_stateless_no_pd</figcaption>
    </figure></p>
<p>完整的封包可以 <a href="https://www.cloudshark.org/captures/3a06e9381ef5" target="_blank" rel="noopener noreffer">在线查看</a> ，也可以从以下链接下载</p>
<p><a href="/ox-hugo/ipv6_faq.file.dhcpv6_stateless_no_pd.pcap" rel="">ipv6_faq.file.dhcpv6_stateless_no_pd.pcap</a></p>
<p>这里需要注意的是，如果 DHCPv6 Stateless 需要获取 PD 的话，那么就不是发送
Information-Request 而是要发送 Solicit 的了。此时的封包应该如下所示：</p>
<p><figure><a class="lightgallery" href="/ox-hugo/ipv6_faq.img.e5693f01.png" title="dhcpv6_stateless_pd" data-thumbnail="/ox-hugo/ipv6_faq.img.e5693f01.png" data-sub-html="<h2>dhcpv6_stateless_pd</h2><p>dhcpv6_stateless_pd</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/ox-hugo/ipv6_faq.img.e5693f01.png"
            data-srcset="/ox-hugo/ipv6_faq.img.e5693f01.png, /ox-hugo/ipv6_faq.img.e5693f01.png 1.5x, /ox-hugo/ipv6_faq.img.e5693f01.png 2x"
            data-sizes="auto"
            alt="/ox-hugo/ipv6_faq.img.e5693f01.png" />
    </a><figcaption class="image-caption">dhcpv6_stateless_pd</figcaption>
    </figure></p>
<p>完整的封包可以 <a href="https://www.cloudshark.org/captures/970a0d48a8e6" target="_blank" rel="noopener noreffer">在线查看</a> ，也可以从以下链接下载</p>
<p><a href="/ox-hugo/ipv6_faq.file.dhcpv6_stateless_pd.pcap" rel="">ipv6_faq.file.dhcpv6_stateless_pd.pcap</a></p>
<h3 id="q-slaac-和-dhcpv6-是如何协同工作的">Q: SLAAC 和 DHCPv6 是如何协同工作的？</h3>
<p>IPv6 允许 SLAAC 和 DHCPv6 同时存在。两者可以并列运行也可以互相配合。</p>
<p>那么主机怎么知道应该通过哪种方式进行呢？这就要说到 RA 包中的 3 个关键 flag 了。</p>
<p><figure><a class="lightgallery" href="/ox-hugo/ipv6_faq.img.b21184c5.png" title="ra_flags" data-thumbnail="/ox-hugo/ipv6_faq.img.b21184c5.png" data-sub-html="<h2>ra_flags</h2><p>ra_flags</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/ox-hugo/ipv6_faq.img.b21184c5.png"
            data-srcset="/ox-hugo/ipv6_faq.img.b21184c5.png, /ox-hugo/ipv6_faq.img.b21184c5.png 1.5x, /ox-hugo/ipv6_faq.img.b21184c5.png 2x"
            data-sizes="auto"
            alt="/ox-hugo/ipv6_faq.img.b21184c5.png" />
    </a><figcaption class="image-caption">ra_flags</figcaption>
    </figure></p>
<ul>
<li>Autonomous flag（简称 A flag）：表示是否配置无状态 IP。在一个 RA 报文中，可存在多个 prefix，比如 2401::/64、2402::/64、2403::/64，每个 prefix 都可以独立配置 A flag
<ul>
<li>为 on 时（对应 bit 位为 1）：表示客户端应当在该 prefix 范围内自动生成 IPv6 地址（客户端通过 DAD 自行保证地址可用），并配置子网路由条目、网关</li>
<li>为 off 时（对应 bit 位为 0）：表示客户端不应当在该 prefix 范围内自动生成 IPv6 地址，但是可以配置子网路由条目、网关</li>
</ul>
</li>
<li>Managed flag（简称 M flag）：表示是否配置有状态 IP。M flag 是 RA 报文的全局参数，一个 RA 报文只有一个 M flag
<ul>
<li>为 on 时（对应 bit 位为 1）：表示在 SLAAC 流程结束后开始 DHCPv6 stateful 流程，也就是告诉客户端可以通过 DHCPv6 来获得 IPv6 地址和其他参数（如 DNS 列表）</li>
<li>为 off 时（对应 bit 位为 0）：表示不通过 DHCPv6 来获得 IPv6 地址</li>
</ul>
</li>
<li>Other flag（简称 O flag）：表示是否通过 DHCPv6 获得除 IP 以外的其他参数（如 DNS 列表）。
O flag 也是 RA 报文中的全局参数，一个 RA 报文只有一个 O flag。 <strong><strong>注意：仅当 M flag 为
off 时，该参数才会被读取。</strong></strong>
<ul>
<li>为 on 时（对应 bit 位为 1）：当 M flag 为 on，或者 M flag 为 off 且至少有一个 A flag 为 on
时，将通过 DHCPv6 获得其他参数</li>
<li>为 off 时（对应 bit 位为 0）：当 M flag 为 on 时，依然将通过 DHCPv6 获得其他参数；当 M
flag 也为 off 时，将不通过 DHCPv6 获得其他参数</li>
</ul>
</li>
</ul>
<p>各 flag 的组合功能可以用下表说明</p>
<table>
<thead>
<tr>
<th>Flag</th>
<th>RA IP</th>
<th>DHCPv6 IP</th>
<th>DHCPv6 DNS</th>
</tr>
</thead>
<tbody>
<tr>
<td>M=1, O=1, A=1</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>M=1, O=1, A=0</td>
<td>N</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>M=1, O=0, A=1</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>M=1, O=0, A=0</td>
<td>N</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>M=0, O=1, A=1</td>
<td>Y</td>
<td>N</td>
<td>Y</td>
</tr>
<tr>
<td>M=0, O=1, A=0</td>
<td>N</td>
<td>N</td>
<td>Y</td>
</tr>
<tr>
<td>M=0, O=0, A=1</td>
<td>Y</td>
<td>N</td>
<td>N</td>
</tr>
<tr>
<td>M=0, O=0, A=0</td>
<td>N</td>
<td>N</td>
<td>N</td>
</tr>
</tbody>
</table>
<p>无状态和有状态并不是相互对立的，他们可以同时存在，也就是一张网卡上可以同时出现通过 RA 生成的 IP 以及通过 DHCPv6 获得的 IP。</p>
<p>主机获取 IP 的过程可以用以下流程图来帮助理解</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">
       ─┬─           ┌─────────────────────┐
        │            │ generate link <span class="nb">local</span> │
        │            │ address             │
        │            └──────────┬──────────┘
        │                       │
        │                       │
        │            ┌──────────▼──────────┐
        │            │ send RS, <span class="nb">wait</span> <span class="k">for</span> RA│
        │            │ from a gateway      │
        │            └──────────┬──────────┘
        │                       │
        │                       │
        │            ┌──────────▼──────────┐
        │            │ RA is received?     ├────────────────────────────────┐
        │            │                     │ N                              │
        │            └──────────┬──────────┘                                │
        │                       │ Y                                         │
        │                       │                                           │
        │            ┌──────────▼──────────┐                                │
                     │ get prefix in RA    │                                │
      SLAAC          │                     │                                │
                     └──────────┬──────────┘                                │
        │                       │                                           │
        │                       │                                           │
        │            ┌──────────▼──────────┐                                │
        │            │ A flag is set?      ├─────────────────┐              │
        │            │                     │ N               │              │
        │            └──────────┬──────────┘                 │              │
        │                       │ Y                          │              │
        │                       │                            │              │
        │            ┌──────────▼──────────┐      ┌──────────▼──────────┐   │
        │            │ generate IP, route, │      │ generate only route │   │
        │            │ gateway             │      │ and gateway         │   │
        │            └──────────┬──────────┘      └──────────┬──────────┘   │
        │                       │                            │              │
        │                       │                            │              │
        │                       ◄────────────────────────────┘              │
        │                       │                                           │
        │                       │                                           │
        │            ┌──────────▼──────────┐      ┌─────────────────────┐   │
       ─┼─           │ M flag is set?      ├──────► O flag is set?      ├───┤
        │            │                     │ N    │                     │ N │
        │            └──────────┬──────────┘      └──────────┬──────────┘   │
        │                       │ Y                          │ Y            │
        │                       │                            │              │
                     ┌──────────▼──────────┐      ┌──────────▼──────────┐   │
      DHCPv6         │ use DHCPv6 get IP   │      │ use DHCP get other  │   │
                     │ and other options   │      │ options             │   │
        │            └──────────┬──────────┘      └──────────┬──────────┘   │
        │                       │                            │              │
        │                       │                            │              │
       ─┴─                      ◄────────────────────────────┴──────────────┘
                                │
                                │
                                ▼

</code></pre></td></tr></table>
</div>
</div><h3 id="q-openwrt-中是如何通过配置项实现-ipv6-各种获取-ip-的方式的">Q: OpenWRT 中是如何通过配置项实现 IPv6 各种获取 IP 的方式的？</h3>
<p>OpenWRT 跟获取 IPv6 地址相关的参数最主要的有 2 个</p>
<ul>
<li>reqaddress 是否通过 DHCPv6 获取 IP</li>
<li>reqprefix DHCPv6 是否请求 IA_PD</li>
</ul>
<table>
<thead>
<tr>
<th>network.wan6.reqaddress</th>
<th>GUI/Request IPv6-address</th>
</tr>
</thead>
<tbody>
<tr>
<td>none</td>
<td>disabled</td>
</tr>
<tr>
<td>try</td>
<td>try</td>
</tr>
<tr>
<td>force</td>
<td>force</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>network.wan6.reqprefix</th>
<th>GUI/Request IPv6-prefix of length</th>
</tr>
</thead>
<tbody>
<tr>
<td>auto</td>
<td>Automatic</td>
</tr>
<tr>
<td>no</td>
<td>disabled</td>
</tr>
<tr>
<td>int value(64, 60&hellip;)</td>
<td>int value(64, 60&hellip;)</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>reqaddress</th>
<th>reqprefix</th>
<th>Method</th>
</tr>
</thead>
<tbody>
<tr>
<td>none</td>
<td>disabled</td>
<td>SLAAC + DHCPv6 stateless (information-request)</td>
</tr>
<tr>
<td>none</td>
<td>auto/int</td>
<td>SLAAC + DHCPv6 stateless (PD in solicit)</td>
</tr>
<tr>
<td>try</td>
<td>disabled</td>
<td>SLAAC + DHCPv6 stateful (no PD in solicit)</td>
</tr>
<tr>
<td>try</td>
<td>auto/int</td>
<td>SLAAC + DHCPv6 stateful (PD in solicit)</td>
</tr>
<tr>
<td>force</td>
<td>disabled</td>
<td>SLAAC + DHCPv6 stateful (no PD in solicit)</td>
</tr>
<tr>
<td>force</td>
<td>auto/int</td>
<td>SLAAC + DHCPv6 stateful (PD in solicit)</td>
</tr>
</tbody>
</table>
<p>force 和 try 的区别在于，如果 DHCPv6 server 不支持 IA_NA，那么 force 会保持
DHCPv6 stateful 模式，然后失败重发 solicit；而 try 会自动切换成 DHCPv6 stateless
模式</p>
<h3 id="q-如何使用-wireshark-过滤-slaac-和-dhcpv6-的封包">Q: 如何使用 wireshark 过滤 slaac 和 dhcpv6 的封包？</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 过滤 NS NA</span>
icmpv6.type<span class="o">==</span><span class="m">135</span> <span class="o">||</span> icmpv6.type <span class="o">==</span> <span class="m">136</span>

<span class="c1"># 过滤指定设备间的 RS RA, dhcpv6</span>
<span class="o">((</span>icmpv6.type <span class="o">==</span> <span class="m">133</span> <span class="o">||</span> icmpv6.type <span class="o">==</span> <span class="m">134</span> <span class="o">||</span> dhcpv6<span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span>eth.addr <span class="o">==</span> &lt;client_mac&gt; <span class="o">||</span> eth.addr <span class="o">==</span> &lt;server_mac&gt;<span class="o">))</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="appendix">Appendix</h2>
<h3 id="ipv6-rfcs">IPv6 RFCs</h3>
<p>本文中提及的 RFC 列表如下</p>
<table>
<thead>
<tr>
<th>RFC No.</th>
<th>RFC Title</th>
</tr>
</thead>
<tbody>
<tr>
<td>4191</td>
<td>Default Router Preferences and More-Specific Routes</td>
</tr>
<tr>
<td>4861</td>
<td>Neighbor Discovery for IP version 6 (IPv6)</td>
</tr>
<tr>
<td>4862</td>
<td>IPv6 Stateless Address Autoconfiguration</td>
</tr>
<tr>
<td>6106</td>
<td>IPv6 Router Advertisement Options for DNS Configuration</td>
</tr>
<tr>
<td>8415</td>
<td>Dynamic Host Configuration Protocol for IPv6 (DHCPv6)</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>更全的 IPv6 相关 RFC 可以参考一下链接</p>
<ul>
<li><a href="http://www.ipamworldwide.com/ipam/ipv6-rfcs.html" target="_blank" rel="noopener noreffer">Key IPv6 Addressing RFCs</a></li>
</ul>
<h3 id="references">References</h3>
<ul>
<li><a href="http://silmor.de/ipv6.php" target="_blank" rel="noopener noreffer">Understanding IPv6</a></li>
<li><a href="https://cciethebeginning.wordpress.com/2012/01/18/ios-dhcpv6-deployment-schemes/" target="_blank" rel="noopener noreffer">IOS DHCPv6 deployment schemes</a></li>
<li><a href="https://dashen.wang/1075.html" target="_blank" rel="noopener noreffer">彻底弄明白有状态与无状态配置IPv6地址</a></li>
<li><a href="http://www.gestioip.net/cgi-bin/subnet_calculator.cgi" target="_blank" rel="noopener noreffer">IPv6 Subnet Calculator</a></li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2023-09-12</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://f0ghua.github.io/ipv6_faq/" data-title="IPv6 FAQ"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://f0ghua.github.io/ipv6_faq/"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://f0ghua.github.io/ipv6_faq/" data-title="IPv6 FAQ"><i class="fab fa-hacker-news fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://f0ghua.github.io/ipv6_faq/" data-title="IPv6 FAQ"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://f0ghua.github.io/ipv6_faq/" data-title="IPv6 FAQ"><i class="fab fa-weibo fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/openwrt-luci/" class="prev" rel="prev" title="openwrt LUCI工作原理浅析"><i class="fas fa-angle-left fa-fw"></i>openwrt LUCI工作原理浅析</a></div>
</div>
<div id="comments"><div id="utterances"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://utteranc.es/">Utterances</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2022 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">fog</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{"utterances":{"darkTheme":"github-dark","issueTerm":"pathname","label":"","lightTheme":"github-light","repo":"f0ghua/hugo_comments"}},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"algoliaAppID":"I9I6IQKZY4","algoliaIndex":"index.cn","algoliaSearchKey":"604ef86245b2a95cadc730cb1dde0244","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
